# TorrentManager 测试模式说明

## 概述

本文档详细说明了 `TorrentManager` 类的测试模式。通过不同的测试模式，可以全面验证 TorrentManager 的各项功能，包括单例模式、下载功能、做种功能、状态查询、并发处理等。

## 测试模式入口

使用 `-t` 或 `--test-manager` 参数进入测试模式：

```bash
程序名 -t <测试模式> [参数...]
```

## 测试模式列表

### 1. 基础功能测试 (`basic`)

#### 用途
测试 TorrentManager 的基本功能，包括下载、状态查询、暂停/恢复、停止等核心功能。

#### 命令格式
```bash
# 模式1: 只测试下载功能
程序名 -t basic <torrent文件> <下载保存路径>

# 模式2: 只测试做种功能
程序名 -t basic <torrent文件> <做种保存路径> --seed

# 模式3: 同时测试下载和做种功能
程序名 -t basic <torrent文件> <下载保存路径> <做种保存路径>
```

#### 参数说明
- `torrent文件`: 要测试的 .torrent 文件路径
- `下载保存路径`: 下载文件的保存目录（模式1和模式3需要）
- `做种保存路径`: 做种文件的保存路径（模式2和模式3需要）
  - 注意：做种保存路径必须指向创建 torrent 时的原始文件或目录
- `--seed`: 标志，表示只测试做种功能（模式2需要）

#### 测试流程

**测试1: 单例模式验证**
- 验证 `getInstance()` 返回的实例是单例
- 检查两个引用是否指向同一个实例
- 这是所有测试模式都会首先执行的测试

**测试2: 启动下载任务**（如果测试下载）
- 调用 `start_download()` 启动下载
- 验证返回的 `info_hash` 不为空
- 显示下载任务的基本信息
- 如果启动失败，测试终止

**测试2/2b: 启动做种任务**（如果测试做种）
- 调用 `start_seeding()` 启动做种
- 验证返回的 `info_hash` 不为空
- 显示做种任务的基本信息
- 如果启动失败，测试终止

**测试3: 状态查询测试**
- 等待2秒让任务开始
- 如果测试下载，对下载任务调用 `get_torrent_status()` 获取状态
  - 验证下载任务状态信息的有效性
  - 显示类型、进度、下载速度等信息
- 如果测试做种，对做种任务调用 `get_torrent_status()` 获取状态
  - 验证做种任务状态信息的有效性
  - 显示类型、进度、上传速度等信息

**测试4: 暂停/恢复测试**
- 如果测试下载：
  - 对下载任务调用 `pause_torrent()` 暂停任务
  - 验证下载任务暂停状态
  - 调用 `resume_torrent()` 恢复下载任务
- 如果测试做种：
  - 对做种任务调用 `pause_torrent()` 暂停任务
  - 验证做种任务暂停状态
  - 调用 `resume_torrent()` 恢复做种任务

**测试5: 统计信息测试**
- 调用 `get_torrent_count()` 获取总任务数
- 调用 `get_download_count()` 获取下载任务数
- 调用 `get_seeding_count()` 获取做种任务数
- 验证统计信息的准确性

**测试6: 运行状态监控**
- 运行10秒，每5秒更新一次状态
- 调用 `wait_and_process()` 处理事件
- 如果测试下载，调用 `print_torrent_status()` 显示下载任务的详细状态
- 如果测试做种，调用 `print_torrent_status()` 显示做种任务的详细状态

**测试7: 停止任务测试**
- 如果测试下载，调用 `stop_torrent()` 停止下载任务并验证
- 如果测试做种，调用 `stop_torrent()` 停止做种任务并验证

#### 示例

**示例1: 只测试下载功能**
```bash
# Windows
DisklessWorkstation.exe -t basic example.torrent C:\Downloads

# 输出示例
=== TorrentManager 测试模式 ===

[测试1] 单例模式测试...
✓ 单例模式测试通过：两个引用指向同一个实例

[测试2] 启动下载测试...
✓ 下载任务启动成功，info_hash: a1b2c3d4e5f6...

[测试3] 状态查询测试...
✓ 下载任务状态查询成功
  类型: 下载
  进度: 0.00%
  下载速度: 0 B/s

[测试4] 暂停/恢复测试...
✓ 下载任务暂停成功
✓ 下载任务暂停状态确认
✓ 下载任务恢复成功

...
```

**示例2: 只测试做种功能**
```bash
# Windows
DisklessWorkstation.exe -t basic example.torrent C:\MyFiles --seed

# 输出示例
=== TorrentManager 测试模式 ===

[测试1] 单例模式测试...
✓ 单例模式测试通过：两个引用指向同一个实例

[测试2] 启动做种测试...
✓ 做种任务启动成功，info_hash: f6e5d4c3b2a1...

[测试3] 状态查询测试...
✓ 做种任务状态查询成功
  类型: 做种
  进度: 100.00%
  上传速度: 0 B/s

[测试4] 暂停/恢复测试...
✓ 做种任务暂停成功
✓ 做种任务暂停状态确认
✓ 做种任务恢复成功

...
```

**示例3: 同时测试下载和做种功能**
```bash
# Windows
DisklessWorkstation.exe -t basic example.torrent C:\Downloads C:\MyFiles

# 输出示例
=== TorrentManager 测试模式 ===

[测试1] 单例模式测试...
✓ 单例模式测试通过：两个引用指向同一个实例

[测试2] 启动下载测试...
✓ 下载任务启动成功，info_hash: a1b2c3d4e5f6...

[测试2b] 启动做种测试...
✓ 做种任务启动成功，info_hash: f6e5d4c3b2a1...

[测试3] 状态查询测试...
✓ 下载任务状态查询成功
  类型: 下载
  进度: 0.00%
  下载速度: 0 B/s
✓ 做种任务状态查询成功
  类型: 做种
  进度: 100.00%
  上传速度: 0 B/s

[测试4] 暂停/恢复测试...
✓ 下载任务暂停成功
✓ 下载任务暂停状态确认
✓ 下载任务恢复成功
✓ 做种任务暂停成功
✓ 做种任务暂停状态确认
✓ 做种任务恢复成功

...
```

#### 适用场景
- 首次使用 TorrentManager 时验证基本功能
- 验证单个下载任务的完整生命周期（模式1）
- 验证单个做种任务的完整生命周期（模式2）
- 验证下载和做种功能在同一个 session 中的协同工作（模式3）
- 调试下载或做种功能相关问题

#### 注意事项
- **模式1（只测试下载）**：只提供下载保存路径即可
- **模式2（只测试做种）**：提供做种保存路径和 `--seed` 标志
- **模式3（同时测试）**：提供两个路径，第一个是下载路径，第二个是做种路径
- 做种保存路径必须指向创建 torrent 时的原始文件或目录
- 任务启动失败会导致测试终止（不会继续其他测试）

---

### 2. 并发测试 (`concurrent`)

#### 用途
测试 TorrentManager 的并发处理能力，验证多个下载和做种任务可以在同一个 session 中同时运行。

#### 命令格式
```bash
程序名 -t concurrent <torrent1> <保存路径1> [torrent2] <保存路径2> ...
```

#### 参数说明
- 参数必须是成对出现：`<torrent文件路径> <保存路径>`
- 可以指定多个 torrent 文件进行并发测试
- 程序会自动尝试启动下载，如果失败则尝试做种

#### 测试流程

1. **解析参数对**
   - 解析所有 `<torrent文件, 保存路径>` 对
   - 显示将要测试的任务数量

2. **启动任务**
   - 对每个参数对，尝试启动下载
   - 如果下载失败，尝试启动做种
   - 记录成功启动的任务（下载和做种分别记录）

3. **状态监控**
   - 运行30秒（或直到所有任务停止）
   - 每5秒更新一次所有任务的状态
   - 显示每个任务的详细信息
   - 显示总体统计信息：
     - 总下载字节数
     - 总上传字节数
     - 总Peer连接数

4. **清理**
   - 测试完成后自动停止所有任务

#### 示例
```bash
# 测试3个任务的并发
DisklessWorkstation.exe -t concurrent \
    file1.torrent C:\Downloads \
    file2.torrent C:\Seeds \
    file3.torrent C:\Downloads

# 输出示例
=== TorrentManager 测试模式 ===

[测试1] 单例模式测试...
✓ 单例模式测试通过：两个引用指向同一个实例

[测试] 并发下载和做种测试...
将测试 3 个任务

--- 任务 #1 ---
Torrent 文件: file1.torrent
保存路径: C:\Downloads
✓ 下载任务启动成功

--- 任务 #2 ---
Torrent 文件: file2.torrent
保存路径: C:\Seeds
✓ 做种任务启动成功

=== 任务启动完成 ===
下载任务: 2 个
做种任务: 1 个
总任务数: 3

开始监控状态（30秒，每5秒更新一次）...

=== 状态更新（5秒） ===
=== 当前 Torrent 状态 (总数: 3, 下载: 2, 做种: 1) ===
...
```

#### 适用场景
- 验证多个任务可以同时运行
- 测试共享 session 的并发性能
- 验证资源管理（内存、连接数等）
- 压力测试

#### 注意事项
- 确保有足够的系统资源（内存、磁盘空间、网络带宽）
- 大量并发任务可能会影响系统性能
- 建议从少量任务开始测试，逐步增加

---

### 3. 交互式测试 (`interactive`)

#### 用途
提供交互式命令行界面，允许用户手动控制 TorrentManager 的各项功能，适合调试和探索性测试。

#### 命令格式
```bash
程序名 -t interactive
```

#### 可用命令

##### `download <torrent文件> <保存路径>`
启动下载任务。

**示例：**
```
> download example.torrent C:\Downloads
✓ 下载已启动，info_hash: a1b2c3d4e5f6...
```

##### `seed <torrent文件> <保存路径>`
启动做种任务。

**示例：**
```
> seed example.torrent C:\MyFiles
✓ 做种已启动，info_hash: f6e5d4c3b2a1...
```

##### `status`
显示所有任务的状态。

**输出示例：**
```
=== 当前 Torrent 状态 (总数: 2, 下载: 1, 做种: 1) ===

--- Torrent #1 ---
Info Hash: a1b2c3d4e5f6...
类型: 下载
状态: 下载中 (Downloading)
进度: 45.23%
...
```

##### `status <info_hash>`
显示指定任务的状态。

**示例：**
```
> status a1b2c3d4e5f6
=== Torrent 状态 ===
Info Hash: a1b2c3d4e5f6...
类型: 下载
...
```

##### `pause <info_hash>`
暂停指定任务。

**示例：**
```
> pause a1b2c3d4e5f6
✓ 已暂停
```

##### `resume <info_hash>`
恢复指定任务。

**示例：**
```
> resume a1b2c3d4e5f6
✓ 已恢复
```

##### `stop <info_hash>`
停止指定任务。

**示例：**
```
> stop a1b2c3d4e5f6
✓ 已停止
```

##### `stop-all`
停止所有任务。

**示例：**
```
> stop-all
✓ 已停止所有任务
```

##### `stats`
显示统计信息。

**输出示例：**
```
统计信息:
  总任务数: 2
  下载任务数: 1
  做种任务数: 1
  [a1b2c3d4...] 下载 45.23%
  [f6e5d4c3...] 做种 100.00%
```

##### `quit` / `exit` / `q`
退出交互式测试。

**示例：**
```
> quit
退出测试...
```

#### 完整使用示例

```bash
# 启动交互式测试
DisklessWorkstation.exe -t interactive

=== 交互式测试模式 ===
输入命令来测试 TorrentManager
可用命令:
  download <torrent文件> <保存路径>  - 启动下载
  seed <torrent文件> <保存路径>       - 启动做种
  status                              - 显示所有状态
  status <info_hash>                  - 显示指定任务状态
  pause <info_hash>                   - 暂停任务
  resume <info_hash>                  - 恢复任务
  stop <info_hash>                    - 停止任务
  stop-all                             - 停止所有任务
  stats                                - 显示统计信息
  quit                                 - 退出

> download file1.torrent C:\Downloads
✓ 下载已启动，info_hash: a1b2c3d4e5f6...

> seed file2.torrent C:\Seeds
✓ 做种已启动，info_hash: f6e5d4c3b2a1...

> status
=== 当前 Torrent 状态 (总数: 2, 下载: 1, 做种: 1) ===
...

> pause a1b2c3d4e5f6
✓ 已暂停

> resume a1b2c3d4e5f6
✓ 已恢复

> stats
统计信息:
  总任务数: 2
  下载任务数: 1
  做种任务数: 1
  [a1b2c3d4...] 下载 45.23%
  [f6e5d4c3...] 做种 100.00%

> stop-all
✓ 已停止所有任务

> quit
退出测试...
```

#### 适用场景
- 调试特定功能
- 探索 TorrentManager 的 API
- 手动测试各种操作组合
- 学习和理解 TorrentManager 的使用方法

#### 技巧
- 使用 `status` 命令可以随时查看所有任务状态
- 使用 `stats` 命令可以快速查看任务概览
- `info_hash` 只需要输入前几个字符即可（程序会自动匹配）
- 命令不区分大小写

---

## 测试模式对比

| 特性 | basic | concurrent | interactive |
|------|-------|------------|-------------|
| **自动化程度** | 完全自动 | 完全自动 | 手动控制 |
| **测试时长** | 约15秒 | 30秒 | 无限制 |
| **任务数量** | 1个 | 多个 | 无限制 |
| **适用场景** | 功能验证 | 并发测试 | 调试探索 |
| **输出详细度** | 中等 | 详细 | 按需显示 |
| **交互性** | 无 | 无 | 完全交互 |

## 测试建议

### 1. 测试顺序
建议按以下顺序进行测试：
1. **basic** - 先验证基本功能正常
2. **concurrent** - 再测试并发能力
3. **interactive** - 最后用于深入调试

### 2. 测试环境准备
- 准备至少一个有效的 .torrent 文件
- 确保有足够的磁盘空间
- 确保网络连接正常（用于连接 tracker 和 peer）
- 对于做种测试，确保文件路径正确

### 3. 常见问题排查

**问题：下载任务启动失败**
- 检查 torrent 文件是否存在且有效
- 检查保存路径是否有写权限
- 检查磁盘空间是否充足

**问题：做种任务启动失败**
- 检查保存路径是否存在
- 检查文件是否完整（与创建 torrent 时的路径一致）
- 检查文件权限

**问题：状态查询返回无效**
- 等待几秒让任务初始化完成
- 检查任务是否已被停止
- 检查 info_hash 是否正确

**问题：并发测试性能差**
- 减少并发任务数量
- 检查系统资源（CPU、内存、网络）
- 检查磁盘 I/O 性能

## 测试输出解读

### 状态信息说明

**状态类型：**
- `checking_files` - 检查文件中
- `downloading` - 下载中
- `finished` - 已完成
- `seeding` - 做种中

**进度信息：**
- `progress` - 下载进度（0.0 - 1.0）
- `downloaded_bytes` - 已下载字节数
- `total_size` - 总大小

**速度信息：**
- `download_rate` - 下载速度（字节/秒）
- `upload_rate` - 上传速度（字节/秒）

**连接信息：**
- `peer_count` - 连接的 peer 数量

## 总结

通过这三种测试模式，可以全面验证 TorrentManager 的各项功能：

- **basic** 模式适合快速验证基本功能
- **concurrent** 模式适合验证并发能力和性能
- **interactive** 模式适合深入调试和探索

建议根据实际需求选择合适的测试模式，或组合使用多种模式进行全面测试。
